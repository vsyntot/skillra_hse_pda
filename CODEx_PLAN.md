# CODEx_PLAN.md — план работ для Codex

Репозиторий: `skillra_hse_pda`  
Контекст:
- Учебный проект по курсу **«Python для анализа данных»** (ВШЭ).
- Продуктовый фундамент **Career & Job Market Navigator — Skillra**.

---

## 0. Контекст и ключевые файлы

### Данные и документация

- ТЗ курса: `docs/00_assignment_TZ.md`
- Продуктовый контекст Skillra: `docs/01_product_context_skillra.md`
- Словарь признаков hh‑датасета: `docs/02_feature_dictionary_hh.md`
- Сырой датасет вакансий: `data/raw/hh_moscow_it_2025_11_30.csv`

### Код и ноутбуки

- Основной ноутбук: `notebooks/01_hse_project.ipynb`
- Пакет: `src/skillra_pda/`:
  - `config.py` — пути и настройки,
  - `io.py` — I/O,
  - `cleaning.py` — предобработка,
  - `features.py` — признаки,
  - `eda.py` — табличные EDA‑агрегации,
  - `viz.py` — визуализации,
  - `market.py` — агрегированная витрина рынка,
  - `personas.py` — персоны и skill‑gap.
- Парсер данных hh.ru: `parser/hh_scraper.py` и сопутствующие файлы.
- Скрипты:
  - `scripts/run_pipeline.py` — основной пайплайн,
  - `scripts/validate_pipeline.py` — smoke‑тест пайплайна,
  - `scripts/validate_notebook.py` — проверка выполнения ноутбука.

---

## 1. Цели

### 1.1. Учебный проект (ВШЭ)

- Показать полный цикл анализа данных на Python:
  - от парсинга hh.ru до агрегированной витрины рынка;
  - от сырых данных до feature engineering и визуализаций.
- Отразить все этапы ТЗ (0–4) в `notebooks/01_hse_project.ipynb`:
  - Этап 0 — источник данных и парсер hh,
  - Этап 1 — предобработка,
  - Этап 2 — признаки,
  - Этап 3 — EDA (зарплаты, форматы, роли, навыки, английский, образование, домены, работодатели),
  - Этап 4 — визуализации и выводы.

### 1.2. Продукт Skillra

- Иметь фичевый датасет в `data/processed/`.
- Иметь `market_view.parquet` как агрегированное представление рынка.
- Иметь personas‑API:
  - `Persona` (цели, ограничения, текущие навыки),
  - `analyze_persona(df, persona)` → market summary + skill‑gap + рекомендации,
  - визуализацию gap’а (`plot_persona_skill_gap`).

---

## 2. Что уже готово (кратко)

- Пайплайн очистки и признаков реализован в `cleaning.py` и `features.py`.
- EDA и визуализации реализованы в `eda.py` и `viz.py`.
- Витрина рынка реализована в `market.py`.
- Персоны и gap‑анализ — в `personas.py`.
- `scripts/run_pipeline.py` и `scripts/validate_pipeline.py` работают.
- `tests/` покрывают ключевые куски логики.
- `notebooks/01_hse_project.ipynb` выполняется `Run All` и соответствует ТЗ.
- `README.md` описывает запуск пайплайна и ноутбука.
- Полезные идеи из `Group_project_draft.ipynb` интегрированы; сам ноутбук удалён.

---

## 3. Технический пайплайн

1. **Загрузка и предобработка**

   - `io.load_raw` → загрузка CSV.
   - `cleaning.handle_missingness`, `cleaning.parse_dates`, `cleaning.salary_prepare`, `cleaning.deduplicate` → чистый датасет.
   - Результат сохраняется в `data/processed/*clean*.parquet`.

2. **Признаки**

   - `features.assemble_features` добавляет:
     - city_tier, work_mode,
     - домены, роли, стек, soft‑skills и бенефиты,
     - признаки английского и образования,
     - salary buckets, vacancy_age_days и др.
   - Результат сохраняется в `data/processed/*features*.parquet`.

3. **Рынок и персоны**

   - `market.build_market_view(df_features)` → `market_view.parquet`.
   - `personas.analyze_persona(df_features, persona)`:
     - строит профиль спроса,
     - считает skill‑gap,
     - выдаёт рекомендации.

---

## 4. Ноутбук 01_hse_project.ipynb

Ноутбук — главный отчёт и витрина проекта:

- Вводная часть и связь с продуктом Skillra.
- Этап 0:
  - откуда берутся данные (парсер hh.ru),
  - как устроен парсинг (фильтры, параметры, ограничения),
  - обзор сырого датасета.
- Этап 1:
  - что делаем при очистке,
  - какие строки/колонки теряем,
  - качество данных после очистки.
- Этап 2:
  - какие engineered features добавляем,
  - почему именно такие признаки важны для анализа и Skillra.
- Этап 3:
  - EDA по зарплатам, форматам, ролям, навыкам, доменам, английскому, образованию, работодателям,
  - корреляционная матрица по числовым признакам.
- Этап 4:
  - набор ключевых визуализаций.
- Продуктовая часть:
  - несколько демонстрационных персон,
  - `analyze_persona` → gap‑анализ и рекомендации.
- Финальные выводы:
  - факты про рынок труда,
  - факты про ценность Skillra.

---

## 5. Связь с парсером и масштабом данных

- Код парсера hh.ru лежит в `parser/` (в том числе `parser/hh_scraper.py`).
- Полный прогон парсера с лимитом `DEFAULT_LIMIT = 10000` занимает **8+ часов**.
- Для тестового прогона нужно:
  - либо изменить `DEFAULT_LIMIT` в `hh_scraper.py` (например, на `50`),
  - либо вызвать скрипт с аргументом `--limit 50` (если поддерживается CLI).
- Данные собираются **ежедневно**, накапливая дельты по активным вакансиям.
- К моменту запуска Skillra планируется накопить **>500k IT‑вакансий** в СНГ с фиксированными указанными зарплатами.

---

## 6. Execution steps for Codex

**Важно для Codex:**

- Шаги выполняются **по одному**.
- Steps **0–10** — уже выполнены, их заново реализовывать не нужно.
- Открытые шаги сейчас: **Step 11** и **Step 12**.

### 6.1. Исторические шаги (Step 0–10) — статус: completed

Список без детализации задач:

- `Step 0` — базовая структура репозитория и конфигурация.
- `Step 1` — устойчивый cleaning пайплайн.
- `Step 2` — богатый feature engineering.
- `Step 3` — EDA по зарплатам, ролям и форматам.
- `Step 4` — EDA по навыкам, стеку и soft‑skills.
- `Step 5` — домены, английский, образование.
- `Step 6` — продуктовый слой с персонами и `analyze_persona`.
- `Step 7` — документация и словарь признаков.
- `Step 8` — интеграция идей из Group_project_draft, удаление черновика, вычищенный EDA/viz.
- `Step 9` — усиленный сторилайн ноутбука и корреляционный анализ.
- `Step 10` — чистый и непротиворечивый README.

Codex может использовать эти шаги как **справку**, но не должен переписывать уже реализованные части без явной просьбы пользователя.

---

### 6.2. Step 11 — Docs cleanup и стабилизация плана

**Разрешённые файлы:**

- `AGENTS.md`
- `CODEx_PLAN.md`
- `README.md` (минимальные правки в секции установки и ссылки)

**Цель:**

1. Убрать служебные артефакты (если будут) из AGENTS и плана.
2. Явно зафиксировать в `CODEx_PLAN.md`, что Steps 0–10 **completed**, а открытые шаги — 11 и 12.
3. В `README.md`:
   - убедиться, что раздел «Установка» упоминает `pip install -r requirements.txt` и необходимость parquet‑движка (`pyarrow`);
   - убедиться, что README не содержит ссылок на `Group_project_draft.ipynb`.

**Название PR:** `step11_docs_cleanup`.

---

### 6.3. Step 12 — Investor‑story ноутбука и полная интеграция визуализаций

**Разрешённые файлы:**

- `notebooks/01_hse_project.ipynb`
- `src/skillra_pda/eda.py`  (только мягкие изменения: добавление/обёртки, не сломать API)
- `src/skillra_pda/viz.py`  (добавление/обновление поведения по возврату фигуры)
- `src/skillra_pda/personas.py` (по необходимости: docstring и лёгкая доработка `plot_persona_skill_gap`)
- `parser/hh_scraper.py`   (добавление комментариев/CLI‑аргумента `--limit`)
- `README.md`              (секция про парсер и запуск)
- `docs/01_product_context_skillra.md` (по желанию: усилить блок про масштаб данных)

**Главная идея:**

Сделать `01_hse_project.ipynb` максимально насыщенным и понятным для:

- проверяющего по Python (видно, что все этапы 0–4 ТЗ закрыты),
- потенциального технологического инвестора Skillra (понятно, что за рынок, как собираем данные, какую ценность даём).

**Задачи:**

1. **Интегрировать неиспользованные функции EDA/Viz и persona‑график**

   - В `eda.py` и `viz.py` найти функции, которые:
     - уже написаны, но не используются в `01_hse_project.ipynb` и скриптах (например, дополнительные salary‑plots, bar‑charts по навыкам, employer‑rating‑plots и т.п.);
   - Для разумного поднабора таких функций:
     - добавить новые EDA‑подразделы в ноутбуке,
     - построить соответствующие графики и/или таблицы,
     - написать markdown‑ячейки с интерпретацией:
       - что показывают графики,
       - какие выводы для рынка и для продукта Skillra.
   - Обязательно использовать `personas.plot_persona_skill_gap`:
     - для одной или нескольких персон построить визуальный график gap’а,
     - вставить график в ноутбук,
     - объяснить, как такая визуализация может быть использована в интерфейсе Skillra.

2. **Сделать так, чтобы графики реально отображались в ноутбуке**

   - Обновить основные функции в `viz.py` так, чтобы:
     - при вызове они не только сохраняли фигуру на диск (если указан `savepath`), но и возвращали `matplotlib.figure.Figure` или `Axes`;
     - в ноутбуке последние строки соответствующих ячеек были вызовами этих функций, чтобы фигуры автоматически отрисовывались в output.
   - Альтернативно (если проще):
     - возвращать путь к сохранённому файлу и в ноутбуке использовать `IPython.display.Image`/`display` для вставки изображений.
   - При этом:
     - **не ломать** существующее поведение скриптов и тестов;
     - при добавлении `return fig` в конец функции это, как правило, сохраняет обратную совместимость (старые вызовы просто игнорируют возвращаемое значение).

3. **Углубить сторителлинг ноутбука (investor‑pitch + ТЗ)**

   - В начале ноутбука (вводная) и в Этапе 0:
     - объяснить, какую проблему решает Skillra как продукт;
     - как именно используется анализ hh‑датасета для проверки продуктовых гипотез;
     - связать этапы ТЗ (0–4) с логикой development’а продукта (например: «Этап 0 — строим датасет, на котором можно запускать Skillra; Этап 3 — понимаем, какие кластеры рынка важны для первичных сегментов пользователей»).
   - В конце каждого основного блока (Этап 0, 1, 2, 3, 4, персоны):
     - явно добавить markdown‑секции:
       - «Что мы сделали на этом шаге»,
       - «Почему мы сделали это именно так»,
       - «Какие выводы для рынка»,
       - «Что это даёт продукту Skillra»,
       - «Какой следующий шаг».
   - Усилить EDA‑блоки:
     - для зарплат, форматов работы, ролей, стека, soft‑skills, доменов и работодателей:
       - добавить дополнительные графики / срезы, используя ранее неиспользованные функции,
       - сделать акцент на практических выводах (например: «есть ли junior‑friendly сегменты», «в каких доменах сильнее всего востребованы ML‑скиллы»).

4. **Подробно рассказать про парсер и масштаб данных**

   - В ноутбуке (Этап 0):
     - подробно описать, как устроен `parser/hh_scraper.py`:
       - какие фильтры (регион, проф. область, грейды),
       - как собирается постранично,
       - какие поля сохраняются;
     - указать, что парсер сейчас запускается **ежедневно**, собирая дельту активных вакансий;
     - явно написать, что к концу учебного года планируется накопить >500k IT‑вакансий с указанными зарплатами в СНГ.
   - В `README.md`:
     - добавить секцию «Парсер hh.ru»:
       - команда для полного прогона (пример: `python parser/hh_scraper.py`),
       - предупреждение о времени выполнения (8+ часов при `DEFAULT_LIMIT = 10000`),
       - инструкция для тестового запуска:
         - изменить `DEFAULT_LIMIT` в `hh_scraper.py` на 50,
         - или вызвать `python parser/hh_scraper.py --limit 50` (если предусмотрен такой параметр);
       - указать, куда складывается результат (например, `data/raw/`).
   - В `docs/01_product_context_skillra.md`:
     - по желанию, добавить 1–2 абзаца про то, что Skillra к моменту запуска будет опираться на историческую базу >500k вакансий.

5. **Сделать каждый шаг в ноутбуке максимально прозрачным**

   - После каждого блока кода, где вызываются функции из `cleaning.py`, `features.py`, `eda.py`, `viz.py`, `personas.py`, добавить:
     - короткое пояснение «что именно здесь делает эта функция» (цель, ключевой эффект, почему это важно);
     - выводы на основе полученных таблиц и графиков (не просто «построили график», а «видим, что…»).
   - Придерживаться последовательности:
     - Код → результат (таблица/график) → текстовые выводы → переход к следующему шагу.

**Критерии готовности:**

- В `01_hse_project.ipynb`:
  - все основные графики видны прямо в ноутбуке;
  - используются ранее неиспользованные EDA/viz‑функции и `plot_persona_skill_gap`;
  - история читается как цельный рассказ для ТЗ и для инвестора.
- README содержит понятную секцию про парсер hh.ru и его запуск.
- Пайплайн и тесты продолжают успешно работать.

**Название PR:** `step12_investor_story_and_viz`.
---

## 7. Правила для Codex при выполнении Step 11 и 12

1. Каждый шаг → отдельный PR:
   - Step 11 → `step11_docs_cleanup`;
   - Step 12 → `step12_investor_story_and_viz`.

2. При выполнении Step 12:
   - **не** менять сырые данные,
   - **не** ломать существующий API `eda`, `viz`, `personas` (допустимо лишь добавлять `return fig`/`Axes` и новые обёртки),
   - все добавленные графики должны либо выводиться напрямую (через возвращаемую фигуру), либо вставляться в ноутбук через `display(Image(...))`.

3. Если какие‑то функции уже используются:
   - Codex не должен их дублировать;
   - можно лишь аккуратно расширить их использование (добавить ещё один вызов или интерпретацию).

---

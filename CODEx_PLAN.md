# CODEx_PLAN — Skillra PDA (Career & Job Market Navigator)

## 1) Цель “целевого состояния”
К моменту сдачи/демо должно быть:

### A) Данные и пайплайн
- Пайплайн воспроизводим: raw → clean → features → market_view.
- Есть явная секция “Data health”: пропуски, unknown, sparse-колонки.
- Аналитика навыков/персон не подмешивает “не-навыки” и мусор.

### B) Ноутбук
- `notebooks/01_hse_project.ipynb` выполняется целиком (Run All) без ошибок.
- Графики не дублируются.
- Все ключевые цифры либо вычисляются, либо явно помечены как “оценка”.
- Шкалы (grade/english) отсортированы логично, `unknown` всегда в конце.
- “Ключевые роли” (frontend/fullstack/product) показывают зарплаты (не пусто).

### C) Репозиторий
- README понятный, есть команды запуска.
- Есть скрипт генерации HTML-отчёта и CSS-стили (не уныло).
- Тесты проходят: `pytest -q`.

---

## 2) Негативные ограничения (важно)
- НЕ менять `parser/` и `data/raw/` без отдельного запроса.
- Все артефакты (графики/таблицы/HTML) сохраняем в `reports/`.

---

## 3) Определение "готово" для каждого PR
- Изменения соответствуют Step’у и его file scope.
- `pytest -q` проходит.
- `python scripts/validate_pipeline.py` проходит.
- Если менялся ноутбук: Run All без ошибок.

---

## 4) Execution steps for Codex

> Важно: выполнять ТОЛЬКО тот Step, который попросил пользователь.
> Один Step = один PR.

---

### Step 28 — Skill universe + Personas: убрать шум и “не-навыки”, повысить ценность skill-gap (P0)
**PR name:** `step28_personas_skill_gap_denoise`

**Цель**
- В skill-gap и топ-скиллы не попадают “особые флаги” (`has_metro`, `has_test_task`, `has_mentoring`) и очевидный шум.
- Для data-персон исключить нерелевантные web-навыки (php/js/html/css), чтобы персоны выглядели правдоподобно.

**Меняем только файлы**
- `src/skillra_pda/personas.py`
- `src/skillra_pda/eda.py` (только если нужно для корректного skill universe)
- `tests/test_personas.py` (если потребуется)
- `docs/02_feature_dictionary_hh.md` (если обновляется логика “что является навыком”)

**Задачи**
1) Расширить список “шумных” skill-колонок:
   - добавить `has_php`, `has_javascript`, `has_html`, `has_css` (и аналогичные web-артефакты, если всплывают),
   - добавить “особые флаги” как НЕ-навыки: `has_metro`, `has_test_task`, `has_mentoring`.
2) Обеспечить, что build_skill_demand_profile и skill_gap_for_persona:
   - исключают “не-навыки” всегда,
   - не рекомендуют web-навыки для data-персон.
3) Добавить/обновить тесты так, чтобы:
   - “особые флаги” не попадали в demand_profile,
   - `has_php/has_javascript` не попадали в recommended_skills для data-персон.

**Проверка**
- `pytest -q`
- `python scripts/validate_pipeline.py`

---

### Step 29 — Зарплаты по ключевым ролям: гарантировать непустые графики (P0)
**PR name:** `step29_salary_key_roles_not_empty`

**Цель**
- В ноутбуке/EDA гарантированно получаем статистики по frontend/fullstack/product, даже если `primary_role` редкий.
- На графике всегда есть результат или корректное сообщение “недостаточно данных” (с N).

**Меняем только файлы**
- `src/skillra_pda/eda.py`
- `src/skillra_pda/viz.py`
- `notebooks/01_hse_project.ipynb`

**Задачи**
1) Добавить EDA-функцию для зарплат по списку ролей:
   - приоритет: использовать `role_*` флаги, если они есть,
   - fallback: `primary_role == <role>`.
   - возвращать таблицу: `role`, `n`, `salary_median`, `salary_p25`, `salary_p75`.
2) Добавить в `viz.py` график (bar/point) для выбранных ролей:
   - подписи N на графике,
   - обработка случая `n=0` (не падать, показывать предупреждение в ноутбуке).
3) В ноутбуке заменить/добавить блок “Зарплаты по ключевым ролям”:
   - роли минимум: `frontend`, `fullstack`, `product`,
   - желательно добавить `backend` для сравнения.
   - вывод: график + мини-таблица.

**Проверка**
- `pytest -q`
- `python scripts/validate_pipeline.py`
- Notebook: Run All

---

### Step 30 — Ноутбук: убрать дубли графиков, исправить nan%, выровнять шкалы и сторилайн (P0)
**PR name:** `step30_notebook_polish_no_duplicates`

**Цель**
- `market_view — nan%` превращается в `N/A` или корректную метрику.
- Графики не дублируются (ни в ноутбуке, ни в HTML).
- `unknown` в конце шкал (включая architect).
- Текст связный и не расходится с данными.

**Меняем только файлы**
- `notebooks/01_hse_project.ipynb`
- `src/skillra_pda/viz.py` (только если нужно для сортировки шкал/категорий)

**Задачи**
1) Исправить блок “эволюция датасета”:
   - если `currency` отсутствует (market_view) → показывать `N/A` вместо процента.
2) Убрать дубли графиков:
   - везде, где используется `display(Image(path))`, вызывать функции визуализации БЕЗ `return_fig=True`,
   - либо оставить фигуру, но тогда НЕ показывать `Image(path)`.
   - выбрать единый стандарт для всего ноутбука.
3) Исправить порядок грейдов:
   - добавить `architect` в порядок ДО `unknown`,
   - гарантировать `unknown` в конце.
4) Исправить сторилайн:
   - добавить связующие абзацы “зачем этот график” и “что это значит”,
   - выверить формулировки, убрать “жёстко вбитые” числа там, где они должны быть вычисляемыми.

**Проверка**
- Notebook: Run All
- (опционально) `python scripts/validate_notebook.py`

---

### Step 31 — HTML-отчёт и финальный лоск репо (P1)
**PR name:** `step31_html_report_style_and_repo_final`

**Цель**
- HTML-отчёт выглядит “как продукт”: читаемо, не уныло.
- В репозитории зафиксирован стиль отчёта (CSS) и команда генерации.

**Меняем только файлы**
- `scripts/validate_notebook.py`
- `reports/notebooks/style.css` (создать)
- `README.md`

**Задачи**
1) Добавить `reports/notebooks/style.css` и подключить его в `validate_notebook.py`.
2) Улучшить CSS:
   - ширина контента, шрифты, таблицы,
   - чуть более “презентационный” вид,
   - не ломать отображение картинок.
3) Обновить README:
   - добавить команду сборки HTML (validate_notebook),
   - указать путь к итоговому HTML.

**Проверка**
- `python scripts/validate_notebook.py` (локально создаёт HTML)
- открыть HTML и убедиться, что графики не дублируются

---

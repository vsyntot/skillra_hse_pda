# CODEx_PLAN

План для Codex/LLM‑агента по работе с репозиторием `skillra_hse_pda`.

Цель:

- закрыть требования курса ВШЭ «Python для анализа данных»;
- построить на этой базе фундамент продукта Career & Job Market Navigator (Skillra);
- сохранить аккуратную архитектуру, читаемый ноутбук и воспроизводимый пайплайн.

---

## 1. Цели проекта

1. **Учебная цель**  
   - Показать полный цикл работы с данными:
     - парсинг hh.ru,
     - предобработка,
     - инженерия признаков,
     - исследовательский анализ,
     - интерпретация результатов.
   - Оформить это в виде одного главного ноутбука `01_hse_project.ipynb`,
     полностью соответствующего ТЗ (`docs/00_assignment_TZ.md`).

2. **Продуктовая цель (Skillra)**  
   - Построить прототип аналитического ядра Skillra:
     - понимать спрос на навыки по ролям, грейдам, городам и форматам работы;
     - оценивать junior‑friendliness сегментов;
     - строить skill‑gap для конкретных персон;
     - агрегировать рынок в удобный для продукта формат (`market_view.parquet`).

---

## 2. Данные и парсер

- Источник данных — вакансии hh.ru по IT‑рынку.
- Базовый CSV для проекта: `data/raw/hh_moscow_it_2025_11_30.csv`.
- Парсер:
  - Код: `parser/hh_scraper.py`.
  - Документация: `parser/README.md`.
  - Поддерживает:
    - фильтрацию по регионам (`--areas`),
    - ограничение числа вакансий (`--limit`, а также `DEFAULT_LIMIT` в коде),
    - вывод в CSV в `data/raw/`.
- Важная продуктовая мысль:
  - парсер может запускаться **ежедневно**;
  - цель — накопить > 500k IT‑вакансий к концу учебного года;
  - текущий датасет — эталонный срез, на котором строится аналитика и сторилайн.

---

## 3. Архитектура и директории

- `src/skillra_pda/config.py` — единый источник путей:
  - `REPO_ROOT`, `DATA_DIR`, `RAW_DATA_DIR`, `PROCESSED_DATA_DIR`,
  - `REPORTS_DIR`, `FIGURES_DIR`, `NOTEBOOKS_DIR`.
- `src/skillra_pda/io.py` — загрузка сырого CSV, сохранение обработанных данных и market view.
- `src/skillra_pda/cleaning.py` — чистка:
  - фильтр RUB‑зарплат,
  - обработка пропусков,
  - обеспечение корректного типа `salary_gross` и других ключевых полей.
- `src/skillra_pda/features.py` — признаки:
  - грейды, tier города, формат работы,
  - роль, навыки, стеки, счётчики ключевых фичей (в т.ч. для ML и data‑ролей).
- `src/skillra_pda/eda.py` — табличный EDA:
  - salary‑summary по категориям,
  - разбивки по городам, грейдам, ролям, форматам,
  - статистики по бенефитам, soft‑skills, английскому, образованию,
  - корреляции.
- `src/skillra_pda/viz.py` — визуализации, работающие поверх `eda.py`.
- `src/skillra_pda/market.py` — агрегаты рынка (market view по ключевым срезам).
- `src/skillra_pda/personas.py` — сущность `Persona`, анализ спроса на навыки и визуализация skill‑gap.

- `scripts/run_pipeline.py`:
  - загружает raw CSV,
  - прогоняет cleaning и features,
  - сохраняет `data/processed/hh_clean.parquet`,
  - сохраняет `data/processed/hh_features.parquet`,
  - строит `data/processed/market_view.parquet`.

- `scripts/validate_pipeline.py`:
  - делает быстрый прогон пайплайна,
  - проверяет инварианты (тип и значения `salary_gross`, наличие `vacancy_age_days` и др.).

- `scripts/validate_notebook.py`:
  - запускает пайплайн,
  - выполняет ноутбук `01_hse_project.ipynb`,
  - генерирует HTML‑отчёт.

---

## 4. Главный ноутбук

`notebooks/01_hse_project.ipynb` — это:

- Полный сторилайн для преподавателя и инвестора:
  - Этап 0 — парсинг hh.ru и исходные данные.
  - Этап 1 — предобработка.
  - Этап 2 — признаки.
  - Этап 3 — EDA по зарплатам, форматам, ролям, навыкам, доменам, английскому, образованию, работодателям.
  - Этап 4 — ключевые визуализации и сводка.
  - Продуктовая часть — персоны и skill‑gap.
  - Итоговые выводы и чек‑лист соответствия ТЗ.
- Все вычисления делаются через функции из `src/skillra_pda`, а не «ручным» кодом в ячейках.

Инварианты ноутбука:

- Должен выполняться целиком (`Run All`) без ошибок.
- Должен быть понятен по структуре:
  - заголовки и подзаголовки отражают этапы,
  - каждая визуализация сопровождается текстом и интерпретацией.

---

## 5. Тесты и качество

- Юнит‑тесты в `tests/`:
  - `test_cleaning.py` — инварианты по очистке (в т.ч. `salary_gross`).
  - `test_features.py` — ключевые признаки (city_tier, primary_role и т.п.).
  - `test_personas.py` — логика demand‑профилей и skill‑gap.
- Все тесты должны проходить при запуске `pytest`.

---

## 6. Execution steps for Codex

Steps 0–12 уже были выполнены и менять их результат не нужно. Они включали:

- базовую структуру пакета, пайплайна и ноутбука;
- реализацию cleaning, features, io, market, personas;
- основную EDA‑логика в `eda.py` и `viz.py`;
- интеграцию идей из `Group_project_draft.ipynb`;
- выстраивание сторилайна ноутбука и приведение `README.md` в соответствие проекту.

Сейчас актуален **только один новый шаг — Step 13**, который отвечает за финальный «полиш» и упаковку проекта.

### Step 13 — Финальный полиш: графики, HTML‑отчёт и репо‑гигиена

**Цель:** сделать репозиторий и артефакты готовыми к показу инвесторам, клиентам и академическому руководителю:  
чистые пути, аккуратные графики, понятный ноутбук, нормальный HTML‑отчёт.

#### 13.1. Область видимости и разрешённые файлы

В этом шаге можно изменять **только**:

- `.gitignore`
- `src/skillra_pda/config.py`
- `src/skillra_pda/viz.py`
- `src/skillra_pda/personas.py`
- `notebooks/01_hse_project.ipynb`
- `scripts/validate_notebook.py`
- `README.md`
- `parser/README.md`
- `docs/01_product_context_skillra.md` (опционально, только чтобы добавить 1–2 абзаца про масштаб данных)

Все остальные файлы считать **замороженными** для этого шага.

#### 13.2. `.gitignore` и генерируемые директории

Задачи:

1. Привести `.gitignore` к следующей логике:

   - **Envs и артефакты Python** (оставить как есть):
     - `.venv/`, `venv/`, `env/`, `.env*`
     - `__pycache__/`, `*.py[cod]`, `*.so`, `*.egg-info/`, `.eggs/`, `build/`, `dist/`, `*.spec`
     - `.cache/`, `.pytest_cache/`, `.mypy_cache/`, `.ruff_cache/`
     - `.ipynb_checkpoints/`, IDE‑директории и т.п.

   - **Логи и временные файлы**:
     - оставить `*.log`.

   - **Данные**:
     - **убрать общую строку `data/`**;
     - игнорировать только:
       - `data/processed/`
       - `data/interim/`
     - не игнорировать:
       - `data/raw/`
       - возможные маленькие sample‑файлы (их можно при необходимости явно перечислить, если они будут добавлены).

   - **Отчёты**:
     - продолжать игнорировать:
       - `reports/figures/`
       - `reports/tables/` (если будет использоваться)
     - для HTML‑отчётов:
       - либо игнорировать `notebooks/*.html` и `reports/notebooks/*.html` (если отчёты считаются полностью генерируемыми),
       - либо оставить их отслеживаемыми, если HTML нужен в git как «прикреплённый артефакт» (на усмотрение владельца репозитория, по умолчанию можно добавить в `.gitignore`).

2. В `src/skillra_pda/config.py`:

   - Убедиться, что есть:
     - `REPORTS_DIR = REPO_ROOT / "reports"`
     - `FIGURES_DIR = REPORTS_DIR / "figures"`
     - `NOTEBOOKS_DIR = REPO_ROOT / "notebooks"`
     - добавить `NOTEBOOK_REPORTS_DIR = REPORTS_DIR / "notebooks"`.
   - В `ensure_directories()` создавать как минимум:
     - `PROCESSED_DATA_DIR`
     - `FIGURES_DIR`
     - `NOTEBOOK_REPORTS_DIR`.

#### 13.3. Папка для графиков персон

В `src/skillra_pda/personas.py`:

- В функции `plot_persona_skill_gap`:

  - Аргумент `output_dir: Path | None = None`.
  - Если `output_dir is None`, использовать **`config.FIGURES_DIR`**, а не `Path("reports/figures")`.
  - Гарантировать, что функция:
    - создаёт директорию, если её нет,
    - сохраняет график в PNG,
    - при `return_fig=True` возвращает `(fig, path)`.

Это убирает дубли по путям и делает визуализацию персон консистентной с остальными графиками.

#### 13.4. Визуализации: размеры, язык и отсутствие дублей

В `src/skillra_pda/viz.py`:

1. Пройти по всем публичным функциям визуализации и:

   - Привести размеры к единым:
     - bar/box/line‑плоты: `figsize=(9, 5)` (или другой разумный, но единый).
     - heatmap: `figsize=(12, 6)` (или другой, но единый).
   - Привести **заголовки графиков и подписи осей к русскому языку**:
     - «Salary by grade» → «Распределение зарплат по грейдам».
     - «Work mode share by city tier» → «Формат работы по типу города».
     - и т.д.

2. Убедиться, что все функции, которые сейчас используются в ноутбуке (`salary_by_domain_plot`, `salary_by_city_mean_count_plot`, `salary_by_grade_mean_count_plot`, `remote_share_by_role_bar`, `top_skills_bar`, heatmap‑функции и т.п.):

   - поддерживают параметр `return_fig: bool = False`;
   - при `return_fig=True` возвращают `(Figure, Path)`.

В `notebooks/01_hse_project.ipynb`:

1. Найти ячейки, где выводятся «пачки» фигур (например, список из нескольких `fig_*`):

   - Разбить эти ячейки на несколько:
     - каждая ячейка выводит **один** `Figure` (или максимум два тесно связанных графика).
   - После каждого вывода графика добавить markdown‑ячейку с интерпретацией:
     - что показано,
     - что это даёт для понимания рынка,
     - что это даёт продукту Skillra.

2. Проверить, нет ли полного дублирования одних и тех же графиков в Этапе 3 и Этапе 4:

   - В Этапе 3 оставить аналитически важные срезы.
   - В Этапе 4 оставить «галерею» 3–5 ключевых визуализаций, которые суммируют историю (можно переиспользовать уже построенные графики логически, но не дублировать без надобности код).

3. Убедиться, что в ячейках нет лишних выводов путей к файлам (`Path(...)`) вместо самих графиков.

#### 13.5. HTML‑отчёт: `scripts/validate_notebook.py`

В `scripts/validate_notebook.py`:

1. Использовать `config.REPORTS_DIR` и `NOTEBOOK_REPORTS_DIR`:

   - HTML‑файл должен сохраняться, например, в:
     - `reports/notebooks/01_hse_project.html`.

2. Обновить вызов `nbconvert`, чтобы он выглядел примерно так:

   ```python
   subprocess.run(
       [
           "jupyter",
           "nbconvert",
           "--to",
           "html",
           "--execute",
           "--no-input",
           f"--ExecutePreprocessor.timeout={DEFAULT_TIMEOUT}",
           "--output-dir",
           str(config.REPORTS_DIR / "notebooks"),
           "--output",
           "01_hse_project",
           str(NOTEBOOK),
       ],
       check=True,
   )
   ```

3. В конце скрипта напечатать путь к сгенерированному HTML‑файлу.

Цель — получить эстетичный HTML‑отчёт без кода, но с таблицами и графиками.

#### 13.6. Парсер и документация

В `README.md` и `parser/README.md`:

1. Проверить, что:

   * описание `--limit` и `DEFAULT_LIMIT` согласовано;
   * ясно указано:

     * как запустить **полный** сбор (с предупреждением, что это может занять ~8 часов);
     * как запустить **тестовый** сбор:

       * либо через изменение `DEFAULT_LIMIT = 50`,
       * либо через `--limit 50`.

2. В `README.md`:

   * В секции про парсер дать короткое резюме:

     * какую задачу решает скрапер,
     * как он вписан в общий пайплайн (данные → анализ → Skillra),
     * ссылку на `parser/README.md` за дополнительными деталями.

#### 13.7. Команда и сторилайн в ноутбуке

В `notebooks/01_hse_project.ipynb`:

1. В секции «Команда и набор задач»:

   * Расширить и деталізировать вклад каждого участника:

     * парсер;
     * пайплайн (cleaning, features, io, market);
     * EDA и визуализации;
     * персоны и продуктовая часть;
     * архитектура репозитория, Codex‑план, тесты.
   * Сделать так, чтобы по ноутбуку было видно:

     * кто за что отвечал,
     * какую часть стека и истории закрывает каждый.

2. Усилить переходы между этапами, добавив мини‑блоки формата:

   * «Что мы сделали в этом этапе»
   * «Почему это сделано именно так с точки зрения анализа данных»
   * «Какие выводы про рынок мы получили»
   * «Что это даёт для продукта Skillra»

3. В Этапе 0 и вводной:

   * Явно описать:

     * что парсер запускается ежедневно;
     * цель накопить > 500k вакансий к концу учебного года;
     * какие ограничения hh.ru учитываются (лимиты выдачи, пагинация по опыту);
     * как сырые поля мапятся на признаки (с отсылкой к `docs/02_feature_dictionary_hh.md`).

#### 13.8. Проверка после Step 13

После выполнения Step 13 должно быть верно:

* `python scripts/run_pipeline.py` — отрабатывает без ошибок.
* `python scripts/validate_pipeline.py` — отрабатывает и печатает адекватные метрики.
* `python scripts/validate_notebook.py` — создаёт HTML‑отчёт в `reports/notebooks/01_hse_project.html` с графиками.
* `pytest` — проходит.
* `notebooks/01_hse_project.ipynb` — выполняется целиком (`Run All`) без ошибок, графики отображаются, сторилайн читается как связный рассказ для проверяющего и инвестора.
# CODEx_PLAN.md — план доведения Skillra HSE PDA до целевого состояния (после шагов 17–22)

Дата: 2025-12-12  
Статус: шаги 17–22 выполнены, но остаются критичные проблемы качества анализа, согласованности ноутбука и HTML-отчёта.

---

## 0) Что НЕ делаем

1) Парсер не трогаем: папка `parser/` — read-only.  
2) Сырые данные не меняем: `data/raw/*.csv` — read-only.  
3) Не “лечим” аналитику новой выгрузкой. Чиним cleaning/features/eda/viz/notebook/export.

---

## 1) Цели (Definition of Done проекта)

### 1.1 Данные и пайплайн
- Есть прозрачная работа с пропусками и `unknown`.
- Есть колонка “грейд для аналитики” с покрытием (например, `grade_final`), чтобы:
  - графики по грейдам не были мусором,
  - персоны не “срывались” в общий рынок из-за малого n.
- Визуализации и расчёты используют единую “вселенную hard skills”.

### 1.2 Ноутбук
- Все графики отображаются в ipynb (и без дублей).
- Выводы не противоречат графикам: ключевые выводы формируются из рассчитанных топов/таблиц.
- Категории (grade/english/work_mode) отсортированы смыслово.

### 1.3 HTML отчёт
- HTML содержит графики внутри (embedded), без кода.
- Отчёт визуально аккуратнее: читабельные шрифты/отступы/ширина контента.

### 1.4 Репозиторий
- README/доки не противоречат коду.
- Есть понятный runbook: pipeline → notebook → html.

---

## 2) Критичные проблемы (почему сейчас “не ок”)

1) Противоречия “текст ↔ график” из-за несогласованности skill-колонок (`skill_*` vs `has_*`).
2) Персоны: из-за слабого покрытия `grade` выборка по junior маленькая → фильтры ослабляются → гэпы становятся странными.
3) Низкая информативность persona-графиков (сырой нейминг, нет подписей долей, нет N рынка).
4) Грейды и английский в графиках/таблицах перемешаны (нет смыслового порядка).
5) HTML отчёт без графиков (выполнение ноутбука/вывод изображений не гарантировано).

---

## 3) Стратегия исправлений

- Делать правки так, чтобы:
  1) не трогать парсер и raw,
  2) минимально менять API функций,
  3) переносить максимум логики из ноутбука в `src/skillra_pda` (но без оверинжиниринга),
  4) обеспечивать воспроизводимость через `scripts/validate_pipeline.py` и `scripts/validate_notebook.py`.

---

# 4) Execution Steps (Codex)

## Step 23 — “Grade final” + смысловые порядки категорий + единая вселенная skills (P0)

### Цель
Сделать так, чтобы:
- у нас был надёжный грейд для аналитики (`grade_final`),
- сортировки категорий были стандартными и едиными,
- навыки анализировались единообразно (hard skills = `skill_*` + `has_*`).

### Файлы (allowlist)
- `src/skillra_pda/features.py`
- `src/skillra_pda/eda.py`
- `src/skillra_pda/viz.py`
- `docs/02_feature_dictionary_hh.md` (при необходимости)

### Задачи
1) Добавить в `features.py` генерацию “грейда из опыта”:
   - на основе `experience` (в raw он заполнен всегда),
   - создать колонку, например: `grade_from_experience`.
2) Создать итоговую колонку `grade_final`:
   - если исходный `grade` не `unknown` → берём `grade`,
   - иначе → берём `grade_from_experience`.
3) В `viz.py` добавить централизованные порядки категорий:
   - `GRADE_ORDER`
   - `ENGLISH_ORDER`
   - `WORK_MODE_ORDER`
   и применять их в соответствующих графиках (grade/english/work_mode).
4) В `eda.py` (или `viz.py`) закрепить единую функцию получения hard skill колонок:
   - использовать уже имеющийся `eda.hard_skill_columns(df)` везде, где топы/матрицы навыков.
5) Обновить `docs/02_feature_dictionary_hh.md`, чтобы описание соответствовало реальному пайплайну и новым колонкам.

### Acceptance Criteria
- `grade_final` присутствует в `df_features` после `assemble_features`.
- Графики по грейдам и английскому выводятся в фиксированном смысловом порядке.
- Никаких разъездов между `skill_*` и `has_*` при построении топов навыков.

### Команды проверки
- `python scripts/validate_pipeline.py`
- `pytest -q`

### PR
- branch: `step-23-grade-final-and-orders`
- PR title: `Step 23: grade_final + category orders + unified hard skills`

---

## Step 24 — Персоны: корректная сегментация + повышение информативности графиков (P0)

### Цель
- Персоны перестают “срываться” в общий рынок из-за малого n.
- Графики по персонам становятся интерпретируемыми и полезными:
  - human-readable названия навыков,
  - подписи долей,
  - N рынка и применённые фильтры на графике/в подписи.

### Файлы (allowlist)
- `src/skillra_pda/personas.py`
- `src/skillra_pda/viz.py`

### Задачи
1) В `personas.py` научить фильтрацию по грейду использовать `grade_final` (если колонка есть).
2) Пересмотреть стратегию “ослабления фильтров”:
   - нельзя молча превращать junior-персону в “все уровни” без явного предупреждения,
   - если фильтр ослаблен — в отчёт персоны и на график выводить это явно.
3) Ограничить “вселенную навыков” для skill-gap:
   - минимум: использовать `eda.hard_skill_columns(df)` и исключить шумные/служебные колонки,
   - лучше: добавить параметр `skill_cols` в анализ и передавать осмысленный список (например, core skills для data-персон).
4) Улучшить `plot_persona_skill_gap(...)`:
   - форматировать skill labels (не `skill_xxx`, а читабельно),
   - добавить подписи процентов,
   - добавить подпись `N рынка` + `filters_used`.

### Acceptance Criteria
- Для `data_student` рынок для skill-gap соответствует junior-сегменту (через `grade_final`) и не требует снятия grade-фильтра.
- На persona-графике видно:
  - доли навыков,
  - N рынка,
  - фильтры/ослабления (если были).

### Команды проверки
- `pytest -q`
- (smoke) выполнить фрагмент персон в ноутбуке/или через python-консоль в dev-среде.

### PR
- branch: `step-24-personas-skillgap-quality`
- PR title: `Step 24: personas segmentation + skill-gap chart improvements`

---

## Step 25 — Полировка ноутбука: графики, непротиворечивые выводы, сторилайн качества данных (P0)

### Цель
- Ноутбук показывает графики внутри ipynb.
- Нет дублей графиков.
- Выводы не “на глаз”, а построены от рассчитанных результатов.
- Встроена понятная история качества данных (unknown/outliers/coverage).

### Файлы (allowlist)
- `notebooks/01_hse_project.ipynb`

### Задачи
1) Везде, где строятся топы навыков, использовать единую “вселенную hard skills”:
   - `eda.hard_skill_columns(df_features)` вместо только `skill_*`.
2) Убрать противоречивые markdown-утверждения:
   - если в выводе перечислены навыки — они должны быть в рассчитанном топе.
   - предпочтительно: выводы формировать в code cell через `display(Markdown(...))` на основе computed top-N.
3) Сделать отображение графиков устойчивым и без дублей:
   - предпочтительный паттерн: сохраняем в файл → `display(Image(path))`.
4) Смысловые сортировки:
   - графики/таблицы по grade, english, work_mode должны идти в правильном порядке.
5) Усилить сторилайн по этапам данных:
   - показать не только raw→clean→features→market_view,
   - но и ключевые “болевые метрики” (grade unknown до/после `grade_final`, salary cap, доля work_mode unknown и т.п.).

### Acceptance Criteria
- В ноутбуке видны графики при Run All.
- Нет дублей.
- Пример с Python/Airflow больше не возникает: если в тексте сказано “Python в must-have”, Python присутствует в топе/графике или есть явная оговорка “вне топ-N”.
- Грейды/английский отсортированы смыслово.

### PR
- branch: `step-25-notebook-polish`
- PR title: `Step 25: notebook polish (plots + consistent conclusions + data quality storyline)`

---

## Step 26 — Полировка HTML-отчёта: графики внутри + эстетика (P0)

### Цель
- `01_hse_project.html` содержит графики.
- HTML без кода, визуально читабельный, аккуратный.

### Файлы (allowlist)
- `scripts/validate_notebook.py`
- `src/skillra_pda/config.py` (только если нужно)
- `README.md` (если нужно уточнить runbook)

### Задачи
1) Убедиться, что `validate_notebook.py`:
   - выполняет ноутбук,
   - экспортирует HTML,
   - встраивает изображения (embed).
2) Добавить лёгкую “эстетику”:
   - CSS-инъекция в HTML (ширина контента, отступы, шрифты, масштаб изображений).
3) (Опционально) Добавить мини-оглавление в начало отчёта (по H1/H2 заголовкам).

### Acceptance Criteria
- Запуск `python scripts/validate_notebook.py` создаёт HTML, в котором есть изображения графиков.
- HTML визуально читабельный, без кода.

### PR
- branch: `step-26-html-report-polish`
- PR title: `Step 26: HTML report with embedded plots + styling`

---

## Step 27 — Полировка репозитория (P1, но желательно)

### Цель
- Репо выглядит как аккуратный продуктовый прототип.
- README/доки соответствуют реальности.
- Понятные команды “как запустить”.

### Файлы (allowlist)
- `README.md`
- `docs/02_feature_dictionary_hh.md`
- `.gitignore` (только если нужно)
- (опционально) `docs/` дополнительные файлы с краткими пояснениями

### Задачи
1) Привести README к фактическому состоянию:
   - про `grade_final`,
   - про генерацию HTML,
   - про `reports/figures` и артефакты.
2) Вынести “Data Quality” секцию:
   - какие проблемы в сырье,
   - как мы их обрабатываем,
   - что показываем в отчёте.
3) Проверить, что репо не содержит лишнего мусора.

### Acceptance Criteria
- README соответствует тому, что реально происходит в коде/ноутбуке.
- Путь “запустить всё” понятен и воспроизводим.

### PR
- branch: `step-27-repo-polish`
- PR title: `Step 27: repo polish (README + docs + runbook)`

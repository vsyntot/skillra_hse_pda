# CODEx_PLAN.md — мастер‑план для `skillra_hse_pda`

Репозиторий: `skillra_hse_pda`

Контекст:
- Учебный проект по курсу **«Python для анализа данных» (ВШЭ)**.
- Продуктовый фундамент **Career & Job Market Navigator — Skillra**.

---

## 0. Контекст и ключевые файлы

### Данные и документация

- ТЗ курса: `docs/00_assignment_TZ.md`
- Продуктовый контекст Skillra: `docs/01_product_context_skillra.md`
- Словарь признаков hh‑датасета: `docs/02_feature_dictionary_hh.md`
- Сырой датасет вакансий: `data/raw/hh_moscow_it_2025_11_30.csv`

### Код и ноутбуки

- Основной ноутбук проекта: `notebooks/01_hse_project.ipynb`
- (Черновой ноутбук команды `notebooks/Group_project_draft.ipynb` уже использован, **в текущей версии репо его быть не должно**.)
- Пакет `src/skillra_pda/`:
  - `cleaning.py` — предобработка,
  - `features.py` — построение признаков,
  - `eda.py` — агрегаты и табличные EDA‑утилиты,
  - `viz.py` — визуализации,
  - `personas.py` — персоны и skill‑gap,
  - `market.py` — агрегированная витрина рынка,
  - `config.py`, `io.py` — пути и ввод/вывод.
- Скрипты:
  - `scripts/run_pipeline.py` — полный пайплайн (from raw to processed),
  - `scripts/validate_pipeline.py` — smoke‑тест пайплайна,
  - `scripts/validate_notebook.py` — генерация HTML‑отчёта ноутбука.

---

## 1. Цели

### 1.1. Учебный проект (ВШЭ)

- Покрыть все этапы ТЗ (0–4) в `01_hse_project.ipynb`.
- Сделать анализ:
  - воспроизводимым,
  - структурированным по этапам,
  - с понятными выводами и цифрами.

### 1.2. Продуктовый фундамент Skillra

- Иметь фичевый датасет и витрину `market_view.parquet` в `data/processed/`.
- Иметь personas‑API:
  - `Persona` с целями/ограничениями/текущими навыками,
  - `analyze_persona(df, persona)` → market summary + skill‑gap + рекомендации,
  - визуализацию `plot_persona_skill_gap`.

---

## 2. Что считается «готово»

- `notebooks/01_hse_project.ipynb` выполняется целиком (**Run All**) и:
  - отражает все этапы ТЗ,
  - рассказывает историю продукта Skillra,
  - показывает ключевые графики и таблицы.
- В `data/processed/` есть:
  - чистый датасет,
  - фичевый датасет,
  - `market_view.parquet`.
- `src/skillra_pda/personas.py` содержит рабочие `Persona`, `analyze_persona`, `plot_persona_skill_gap`.
- `docs/02_feature_dictionary_hh.md` описывает основные сырые и engineered‑признаки.
- Скрипты `run_pipeline.py`, `validate_pipeline.py`, `validate_notebook.py` выполняются без ошибок.

Подробная реализация разбита на шаги ниже.

---

## 6. Execution steps for Codex

### Общие правила

- Шаги выполняются **по одному**.
- Пользователь всегда пишет:  
  > «Сделай Step N из раздела "6. Execution steps for Codex"».
- Codex **не пытается** выполнить все шаги сразу.
- Каждый Step N → отдельный PR.

---

### 6.1. Исторические шаги (0–13) — уже выполнены

Эти шаги **уже реализованы** в текущей кодовой базе.  
Повторно их трогать можно только если пользователь прямо попросит.

Краткое содержание:

- **Step 0 — Sanity‑check**  
  Проверка структуры репо, наличия `AGENTS.md` и `CODEx_PLAN.md`.

- **Step 1 — Домены (domain_*)**  
  EDA по доменам, функции `extract_primary_domain`, `describe_salary_by_domain`, графики `salary_by_domain_plot`.

- **Step 2 — Английский и образование**  
  EDA по требованиям к английскому и образованию, таблицы и графики, выводы в ноутбуке.

- **Step 3 — Работодатели, бенефиты и soft‑skills**  
  Топ работодателей, тепловые карты бенефитов и soft‑skills, отдельная секция в ноутбуке.

- **Step 4 — Personas & analyze_persona**  
  Богатый объект `Persona`, функция `analyze_persona(df, persona)`, раздел с персонами в ноутбуке.

- **Step 5 — Market view и run_pipeline**  
  Витрина `build_market_view` и скрипт `run_pipeline.py`, сохраняющий processed‑датасеты.

- **Step 6 — Тесты и validate_pipeline**  
  Мини‑тесты для ключевых функций, улучшенный `validate_pipeline.py`, инструкции по `pytest`.

- **Step 7 — Документация и полиш**  
  Обновлённый словарь признаков, README и финальные выводы в ноутбуке.

- **Step 8 — Интеграция идей из Group_project_draft**  
  Перенос полезных EDA‑идей в код и основной ноутбук, удаление чернового ноутбука, приведение тестов в порядок.

- **Step 9 — Усиление сторилайна и корреляционного анализа**  
  Чёткая структура этапов 0–4, подробный этап 0 про парсер и датасет, блок с корреляционной матрицей и интерпретацией.

- **Step 10 — Чистый и непротиворечивый README**  
  README, который описывает цели проекта, структуру репо, запуск пайплайна, анализ ноутбука и personas‑API.

- **Step 11 — Структура отчётов и директорий**  
  Единая конфигурация путей (`FIGURES_DIR`, `NOTEBOOK_REPORTS_DIR` и т.п.), аккуратный `.gitignore`.

- **Step 12 — Investor‑story ноутбука и полная интеграция визуализаций**  
  Подробный сторителлинг для инвестора, использование неиспользованных ранее графиков и persona‑визуализаций в ноутбуке, улучшенное описание парсера.

- **Step 13 — Финальный полиш: графики, HTML‑отчёт и репо‑гигиена**  
  Унификация размеров/подписей графиков, улучшенный HTML‑отчёт, синхронизация README и parser‑README.

---

### 6.2. Активные шаги: 14–16

Ниже — новые шаги, которые ещё **не выполнены** и которые мы будем делать сейчас.

---

### Step 14 — Цифры vs текст и эволюция датасета

**Идея:**  
Сделать так, чтобы каждый текстовый вывод в ноутбуке опирался на явно посчитанные цифры и чтобы читателю было видно, как меняется датасет по этапам (raw → clean → features → market_view).

**Разрешённые файлы:**

- `notebooks/01_hse_project.ipynb`
- при необходимости (минимально!) — `docs/02_feature_dictionary_hh.md`  
  *(только для добавления кратких пояснений, без ломания структуры).*

**Задачи:**

1. **Эволюция датасета по этапам**
   - В ноутбуке добавить отдельную таблицу/markdown‑блок «Эволюция датасета»:
     - количество строк и колонок:
       - после чтения raw,
       - после cleaning,
       - после feature engineering,
       - после фильтров, если они есть,
     - ключевые доли:
       - доля вакансий с указанной зарплатой,
       - доля non‑RUB вакансий,
       - доля строк, где удалёнка/гибрид/офис и т.п.
   - Все числа должны вычисляться в коде (например, `len(df_raw)`, `len(df_clean)` и т.п.), а не забиваться руками.

2. **Связка текст ↔ числа**
   - Для каждого блока выводов (зарплаты, форматы, роли, навыки, англ/образование, работодатели):
     - проверить существующие формулировки («большинство», «около 60%» и т.п.),
     - добавить рядом конкретные цифры или диапазоны, например:
       - «55–60% вакансий в Москве предлагают формат office+hybrid»,
       - «≈65% вакансий с английским на уровне B1+».
   - При необходимости обновить текст, если фактические цифры не совпадают с текущими формулировками.

3. **Явная подсветка категорий `unknown`**
   - В блоках, где есть значимая доля `unknown` (формат работы, стек, англ, образование и т.п.):
     - посчитать долю `unknown`,
     - добавить в текст дисклеймер:
       - «X% вакансий не указывают формат, поэтому реальные доли remote/hybrid могут быть выше».
   - Не менять при этом сам pipeline очистки — только аналитический слой в ноутбуке.

4. **Чек‑лист по этапам**
   - В конце каждого этапа (0–4) добавить маленький списочек:
     - «Сколько строк и признаков было до этапа»,
     - «Сколько стало после»,
     - «Основные потери/изменения (например, удалили Y дубликатов, Z вакансий без зарплаты)».

**Название PR:** `step14_notebook_numbers_alignment`.

---

### Step 15 — Здоровье датасета и политика `unknown`/NaN

**Идея:**  
Сделать явной «data health»‑картинку: как мы обращаемся с пропусками и маркерами вроде `"unknown"`, чтобы аналитика и интерпретации были честными и воспроизводимыми.

**Разрешённые файлы:**

- `src/skillra_pda/cleaning.py`
- `src/skillra_pda/features.py`
- `src/skillra_pda/eda.py` (только для утилит/агрегатов)
- `notebooks/01_hse_project.ipynb`
- `docs/02_feature_dictionary_hh.md`

**Задачи:**

1. **Функция/утилита для профайлинга качества данных**
   - В `cleaning.py` или `eda.py` добавить функцию вида:

     ```python
     def summarize_data_health(df: pd.DataFrame, prefix: str = "") -> pd.DataFrame:
         """Сводная таблица по качеству данных:
         доля NaN, доля 'unknown', тип признака и т.п."""
     ```

   - Таблица должна как минимум показывать:
     - тип признака,
     - % NaN,
     - % значений из множества `{"unknown", "Unknown", "не указано", ...}` для категориальных столбцов,
     - при необходимости — простые комментарии («кандидат для удаления», «здесь high‑missing»).

2. **Стандартизация маркеров `unknown`**
   - В `cleaning.py`:
     - определить единый набор текстовых маркеров `UNKNOWN_MARKERS` (`"unknown"`, `"Unknown"`, `"не указано"`, `"nan"`, пустая строка и т.п.),
     - аккуратно привести категориальные столбцы к:
       - либо `NaN`,
       - либо нормализованной категории `"unknown"` (в тех случаях, где наличие отдельной категории осмысленно).
   - Важно:
     - не ломать существующую логику типов (особенно для булевых колонок),
     - не возвращать `object` там, где уже используется `boolean/Int64`.

3. **Интеграция профайлинга в ноутбуке**
   - В `01_hse_project.ipynb`:
     - добавить один‑два блока, где вызывается `summarize_data_health` для:
       - raw‑датасета,
       - очищенного датасета,
       - фичевого датасета (по желанию).
     - на основе этих таблиц написать текст:
       - какие признаки «чистые»,
       - какие несут много пропусков/unknown,
       - какие решения были приняты (оставляем, агрегируем, игнорируем в ключевых метриках).

4. **Документация по признакам и пропускам**
   - В `docs/02_feature_dictionary_hh.md`:
     - у ключевых признаков (work_mode, english_level, education_level, stack и т.п.) явно указать:
       - что делают с NaN,
       - что значит категория `unknown`,
       - участвует ли этот признак в финальных метриках/графиках.

**Название PR:** `step15_data_health_and_unknown_policy`.

---

### Step 16 — HTML‑отчёт 2.0 и презентационный пакет

**Идея:**  
Сделать красивый, самодостаточный HTML‑отчёт по ноутбуку, который можно показать инвестору/руководителю **без Jupyter** — с графиками, минималистичным кодом (скрытым) и оглавлением.

**Разрешённые файлы:**

- `scripts/validate_notebook.py`
- `src/skillra_pda/config.py` (только для путей)
- `notebooks/01_hse_project.ipynb` (минимальные правки, если нужны для корректного экспорта)
- при желании:
  - `reports/` (новые шаблоны/ресурсы),
  - `README.md` (обновить инструкцию по HTML‑отчёту).

**Задачи:**

1. **Экспорт через nbconvert API**
   - В `scripts/validate_notebook.py`:
     - вместо чистого CLI‑вызова `jupyter nbconvert` использовать Python‑API `nbconvert`:
       - запускать ноутбук через `ExecutePreprocessor`,
       - экспортировать HTML через `HTMLExporter` с:
         - включёнными outputs,
         - выключенным кодом (`exclude_input=True` или аналог),
         - адекватной темой (`lab` или `classic`).
     - сохранять результат в `reports/notebooks/01_hse_project.html`  
       (путь брать из `config.NOTEBOOK_REPORTS_DIR`).

2. **Мини‑стили и оглавление**
   - Добавить базовый CSS (через шаблон или `extra_css`) для:
     - удобных отступов,
     - читабельных заголовков,
     - нормального масштаба графиков.
   - Убедиться, что в HTML есть:
     - оглавление по основным разделам (Этап 0–4, EDA, персоны, выводы),
     - кликабельные якоря.

3. **Проверка наличия графиков**
   - Убедиться, что итоговый HTML содержит встроенные графики:
     - если нужно — убедиться, что функции визуализации возвращают `Figure` и они действительно отрисованы в ноутбуке перед экспортом;
     - не полагаться на путь к PNG без отображения.

4. **Инструкция в README**
   - В `README.md` добавить/уточнить раздел:
     - «Как получить HTML‑отчёт»:
       - команда `python scripts/validate_notebook.py`,
       - путь к результату (`reports/notebooks/01_hse_project.html`),
       - для чего этот отчёт (демо инвесторам/руководителям/преподавателю).

**Название PR:** `step16_html_report_investor_ready`.

---

## 7. Правила для Codex при выполнении шагов

1. Каждый **Step N** — отдельная задача и отдельный PR.
2. При выполнении Step N:
   - не изменяй файлы, не перечисленные в этом шаге;
   - не переписывай уже рабочие функции без явной причины;
   - не пытайся делать другие Steps (N±1 и т.д.).
3. Если код уже реализует то, что описано в шаге:
   - либо пропусти шаг,
   - либо сделай минимальные улучшения (docstring, выводы в ноутбуке, косметика).
4. После шагов, которые меняют ноутбук или пайплайн:
   - проверяй `python scripts/run_pipeline.py`,
   - проверяй `python scripts/validate_notebook.py`,
   - по возможности запускай `pytest`.

---

## 8. QA / Run‑All чек‑лист

Перед тем как считать проект завершённым:

- `notebooks/01_hse_project.ipynb` выполняется **с нуля** без ручных вмешательств.
- Пути к данным работают из корня репозитория.
- Все ключевые графики сохранены в `reports/figures/`.
- В `data/processed/` лежат:
  - чистый датасет,
  - фичевый датасет,
  - `market_view.parquet`.
- HTML‑отчёт `reports/notebooks/01_hse_project.html` собирается и содержит графики.
- В начале ноутбука есть распределение вкладов участников команды.
- Минимум два новых признака действительно реализованы (а не просто переименованы старые).

---

## 9. НЕ‑цели (чтобы не утонуть)

- Не строим «идеальную» ML‑модель предсказания зарплаты (можно как бонус, но только после закрытия основных задач).
- Не делаем веб‑интерфейс поверх этого репозитория.
- Не переписываем hh‑парсер с нуля без согласования.

---

## 10. Порядок коммитов (рекомендация)

1. Обновление планов/AGENTS/README.
2. Правки пайплайна (cleaning/features/market).
3. Обновления EDA/viz и ноутбука.
4. Personas и продуктовый слой.
5. Тесты и валидационные скрипты.
6. HTML‑отчёт и финальный полиш.

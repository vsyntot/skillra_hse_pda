# CODEx_PLAN.md — мастер‑план для `skillra_hse_pda`

Репозиторий: `skillra_hse_pda`  
Контекст:  
- Учебный проект по курсу **«Python для анализа данных»** (ВШЭ).  
- Продуктовый фундамент **Career & Job Market Navigator — Skillra**.

---

## 0. Контекст и ключевые файлы

### Данные и документация

- ТЗ курса: `docs/00_assignment_TZ.md`
- Продуктовый контекст Skillra: `docs/01_product_context_skillra.md`
- Словарь признаков hh-датасета: `docs/02_feature_dictionary_hh.md`
- Сырой датасет вакансий: `data/raw/hh_moscow_it_2025_11_30.csv`

### Код и ноутбуки

- Основной ноутбук: `notebooks/01_hse_project.ipynb`
- Черновой ноутбук команды: `notebooks/Group_project_draft.ipynb` (источник идей, будет удалён после Step 8)
- Пакет: `src/skillra_pda/`
  - `cleaning.py` — предобработка
  - `features.py` — признаки
  - `eda.py` — EDA‑утилиты
  - `viz.py` — визуализации
  - `personas.py` — персоны и skill‑gap
  - `market.py` — агрегированная витрина рынка
  - `io.py`, `config.py` — I/O и пути
- Скрипты:
  - `scripts/validate_pipeline.py` — smoke‑тест
  - `scripts/run_pipeline.py` — основной пайплайн

---

## 1. Цели

### 1.1. Учебный проект (ВШЭ)

- Отразить все этапы ТЗ (0–4) в `notebooks/01_hse_project.ipynb`. :contentReference[oaicite:4]{index=4}  
- Дать чистый, воспроизводимый анализ:
  - загрузка и предобработка,
  - признаки,
  - EDA (зарплаты, форматы работы, роли, навыки, английский, образование, домены, работодатели),
  - визуализации (включая корреляционную матрицу),
  - финальные выводы.

### 1.2. Продуктовый фундамент Skillra

- Иметь фичевый датасет + `market_view.parquet` в `data/processed/`.  
- Иметь personas‑API:
  - `Persona` (цели, ограничения, текущие навыки),
  - `analyze_persona(df, persona)` → market summary + skill‑gap + рекомендации.

---

## 2. Что считается «готово»

1. `notebooks/01_hse_project.ipynb`:
   - выполняется **Run All** без ошибок,
   - чётко следует структуре этапов 0–4 ТЗ,
   - содержит:
     - подробное описание парсинга hh (Этап 0),
     - предобработку и диагностику качества данных (Этап 1),
     - описание ключевых engineered features (Этап 2),
     - EDA по зарплатам/форматам/ролям/навыкам/доменам/английскому/образованию/работодателям (Этап 3),
     - визуализации, в т.ч. корреляционную матрицу (Этап 4),
     - продуктовую часть (персоны, skill‑gap),
     - итоговые выводы и чек‑лист соответствия ТЗ.

2. В `data/processed/` есть:
   - чистый датасет (например, `hh_clean.parquet`),
   - фичевый датасет (например, `hh_features.parquet`),
   - витрина рынка `market_view.parquet`.

3. В `src/skillra_pda/personas.py`:
   - реализован dataclass `Persona`,
   - реализована функция `analyze_persona(df, persona, top_k=10)`.

4. В `docs/02_feature_dictionary_hh.md` описаны:
   - исходные признаки,
   - все ключевые engineered features,
   - структура витрины `market_view`.

---

## 3. Общие принципы работы (для людей и Codex)

1. Не трогать `data/raw/*`.
2. Вся логика:
   - чтение/запись данных — в `io.py` и `config.py`,
   - очистка — в `cleaning.py`,
   - feature engineering — в `features.py`,
   - EDA, агрегации — в `eda.py`,
   - графики — в `viz.py`,
   - персоны и skill‑gap — в `personas.py`,
   - рыночная витрина — в `market.py`.

3. Ноутбук `01_hse_project.ipynb` — витрина и учебный отчёт:
   - только вызовы функций из `src/`,
   - таблицы и графики,
   - текстовые выводы и storytelling.

4. Тесты:
   - minimal, но покрывают критичные функции (очистка, признаки, персоны).

---

## 4. Корреляционная матрица

Отдельный акцент:

- В `eda.py` должна быть функция для построения корреляционной матрицы по числовым признакам (например, `correlation_matrix(df)`).
- В `viz.py` должна быть функция для построения heatmap (например, `corr_heatmap(corr_df, ...)`).
- В `01_hse_project.ipynb` должен быть отдельный блок:
  - расчёт корреляций между ключевыми числовыми фичами,
  - heatmap,
  - текстовая интерпретация.

Если функции уже существуют, нужно убедиться, что они используются в ноутбуке.

---

## 5. Интеграция идей из чернового ноутбука

- `notebooks/Group_project_draft.ipynb` содержит полезные эксперименты и идеи команды.
- Цель: забрать из него всё ценное:
  - интересные EDA/графики/метрики,
  - потенциально полезные функции,
- интегрировать в:
  - `src/skillra_pda/eda.py`, `viz.py`, `personas.py`, `market.py`,
  - и в storyline `01_hse_project.ipynb`.
- После этого `Group_project_draft.ipynb` удаляется.

---

## 6. Execution steps for Codex

**Важно для Codex:**  
Эти шаги выполняются **по одному**.  
Пользователь всегда говорит явно: «сделай Step N».  
Не пытайся выполнить все шаги одновременно.

Статус:  
- Steps 0–7 в основном уже реализованы в кодовой базе и ноутбуке.  
  Они остаются в плане как спецификация и точка проверки.  
- Steps 8–10 описывают финальный polishing, усиление сторилайна и чистку.

---

### Step 0 — Санити‑чек (без изменений кода)

**Цель:** убедиться, что окружение и структура репо нормальные.

**Разрешённые файлы:** никакие (шаг без изменений кода).

**Действия для Codex:**

- Никаких изменений в коде.
- Проверить логически, что:
  - структура папок соответствует описанию в секции 0,
  - `AGENTS.md` и `CODEx_PLAN.md` лежат в корне,
  - основная работа ведётся в `main` или отдельной рабочей ветке.

**Ожидаемый PR:** нет.

---

### Step 1 — Домены (domain_*) в EDA и ноутбуке

> ⚠️ В текущей базе этот шаг **частично уже сделан**.

**Разрешённые файлы:**

- `src/skillra_pda/eda.py`
- `src/skillra_pda/viz.py`
- `notebooks/01_hse_project.ipynb`
- при необходимости: новые фигуры в `reports/figures/*`

**Цель:**

- Использовать `domain_*` признаки:
  - функции `extract_primary_domain`, `describe_salary_by_domain` в `eda.py`;
  - визуализация `salary_by_domain_plot` в `viz.py`;
  - отдельный раздел в ноутбуке («Рынок по доменам»).

**Название PR:** `step1_domain_eda`.

---

### Step 2 — Английский и образование

> ⚠️ Этот шаг также частично реализован.

**Разрешённые файлы:**

- `src/skillra_pda/eda.py`
- `src/skillra_pda/viz.py`
- `notebooks/01_hse_project.ipynb`
- `reports/figures/*`

**Цель:**

- EDA по английскому:
  - функции `english_requirement_stats` + `salary_by_english_level_plot`,
  - раздел в ноутбуке (таблицы, графики, выводы).
- EDA по образованию:
  - функции `education_requirement_stats` + `salary_by_education_level_plot`,
  - раздел в ноутбуке (таблицы, графики, выводы).

**Название PR:** `step2_english_education_eda`.

---

### Step 3 — Работодатели, бенефиты и soft‑skills

**Разрешённые файлы:**

- `src/skillra_pda/eda.py`
- `src/skillra_pda/viz.py`
- `notebooks/01_hse_project.ipynb`
- `reports/figures/*`

**Цель:**

- EDA по работодателям:
  - `top_employers`, `benefits_by_employer`, `soft_skills_by_employer` в `eda.py`;
  - heatmap’ы `benefits_employer_heatmap`, `soft_skills_employer_heatmap` в `viz.py`.
- В ноутбуке:
  - секция «Топ работодатели, бенефиты и soft‑skills» с таблицами, heatmap и выводами.

**Ограничения:**

- Не ломать существующие функции.
- В ноутбуке только добавлять/уточнять, не переписывать всё.

**Название PR:** `step3_employers_benefits_softskills`.

---

### Step 4 — Personas & analyze_persona

**Разрешённые файлы:**

- `src/skillra_pda/personas.py`
- `notebooks/01_hse_project.ipynb`

**Цель:**

1. Расширить `Persona` (описание, цели, ограничения).
2. Реализовать/доработать:

    ```python
       analyze_persona(df, persona, top_k=10) -> dict
    ```
    
    * со структурой: `market_summary`, `skill_gap`, `recommended_skills`.

3. В ноутбуке:

   * использовать `analyze_persona` для нескольких предопределённых персон,
   * для каждой показывать summary, таблицу gap и рекомендации.

**Название PR:** `step4_personas_analyze_persona`.

---

### Step 5 — Market view и run_pipeline

**Разрешённые файлы:**

* `src/skillra_pda/market.py`
* `scripts/run_pipeline.py`
* при необходимости: `src/skillra_pda/__init__.py`
* `README.md`

**Цель:**

1. Убедиться, что `build_market_view(df_features)` в `market.py`:

   * группирует данные по (primary_role, grade, city_tier, domain),
   * считает `vacancy_count`, `salary_q25/median/q75`, `junior_friendly_share`, `remote_share`, метрики по стеку, `top_skills`.

2. `scripts/run_pipeline.py`:

   * загружает raw,
   * вызывает cleaning,
   * вызывает feature engineering,
   * строит `market_view`,
   * сохраняет всё в `data/processed/`.

3. В README:

   * описать, как запускать пайплайн и какие файлы появляются в `data/processed/`.

**Название PR:** `step5_market_view_pipeline`.

---

### Step 6 — Тесты и улучшение validate_pipeline

**Разрешённые файлы:**

* `tests/test_cleaning.py`
* `tests/test_features.py`
* `tests/test_personas.py`
* `scripts/validate_pipeline.py`
* `README.md` (раздел «Как проверить проект»)

**Цель:**

1. Тесты:

   * `test_cleaning.py`: проверка обработки `salary_gross` и пропусков,
   * `test_features.py`: `add_city_tier`, `add_primary_role`,
   * `test_personas.py`: `build_skill_demand_profile` / `skill_gap_for_persona`.

2. `validate_pipeline.py`:

   * вывод ключевых метрик очистки (дубликаты, dropped_cols, non‑RUB share).

3. README:

   * добавить команды `python scripts/validate_pipeline.py` и `pytest`.

**Название PR:** `step6_tests_and_validation`.

---

### Step 7 — Документация и базовый финальный полиш

**Разрешённые файлы:**

* `docs/02_feature_dictionary_hh.md`
* `docs/01_product_context_skillra.md` (при необходимости)
* `README.md`
* `notebooks/01_hse_project.ipynb`

**Цель:**

1. Обновить словарь признаков:

   * описать все ключевые engineered features и витрину `market_view`.

2. В README/доках:

   * описать запуск пайплайна,
   * кратко описать personas‑API и `market_view`.

3. В ноутбуке:

   * привести заголовки и нумерацию в порядок,
   * обновить финальные выводы, учитывая все EDA.

**Название PR:** `step7_docs_and_polish`.

---

### Step 8 — Интеграция идей из Group_project_draft, использование неиспользуемых функций, фиксы тестов и EDA/viz‑cleanup

**Разрешённые файлы:**

* `notebooks/01_hse_project.ipynb`
* `notebooks/Group_project_draft.ipynb` (только для чтения и последующего удаления)
* `src/skillra_pda/eda.py`
* `src/skillra_pda/viz.py`
* `tests/test_cleaning.py`
* `tests/test_features.py`
* `tests/test_personas.py`
* при необходимости: `reports/figures/*`
* при необходимости: минимальные обновления `docs/02_feature_dictionary_hh.md`

**Цель:**

1. **Интегрировать полезные идеи из `Group_project_draft.ipynb`:**

   * найти графики, анализы и метрики, которых нет в `01_hse_project.ipynb`, но которые дают ценность;
   * вынести их логику в функции `eda.py`/`viz.py` (если она там не реализована);
   * добавить соответствующие секции в `01_hse_project.ipynb` с вызовами этих функций и текстовыми выводами.

2. **Использовать неиспользуемые функции:**

   * найти функции в `eda.py`/`viz.py`, которые:

     * либо используются только в черновом ноутбуке,
     * либо пока не вызываются;
   * попытаться встроить их в storyline `01_hse_project.ipynb` (EDA, графики, дополнительные метрики) или в скрипты (`run_pipeline.py`, `validate_pipeline.py`);
   * только если функция явно не нужна и дублирует другую — удалить её с понятным комментарием в PR.

3. **Починить и стабилизировать тесты:**

   * убрать глобальные stubs/хаки (например, подмену `src.skillra_pda.personas` в `sys.modules`), которые ломают другие тесты;
   * добиться, чтобы `pytest` проходил на всём проекте.

4. **Удалить `Group_project_draft.ipynb`:**

   * после переноса всего полезного удалить файл из репозитория;
   * убедиться, что он не фигурирует в README и других документах.

**Название PR:** `step8_group_draft_integration`.

---

### Step 9 — Усиление сторилайна и корреляционного анализа в 01_hse_project.ipynb

**Разрешённые файлы:**

* `notebooks/01_hse_project.ipynb`

**Цель:**

Сделать `01_hse_project.ipynb` максимально подробным и самодостаточным:

* чёткая структура по этапам 0–4 ТЗ,
* детальное описание парсинга, предобработки и feature engineering,
* полноценный storytelling по EDA,
* отдельный блок с корреляционной матрицей,
* продуктовая часть с персонами,
* финальные выводы + чек‑лист соответствия ТЗ.

**Задачи:**

1. **Структура и заголовки:**

   * убедиться, что есть секции:

     * вводная (контекст проекта и данных),
     * Этап 0: парсинг hh.ru,
     * Этап 1: предобработка,
     * Этап 2: признаки,
     * Этап 3: EDA (зарплаты, форматы, роли, навыки, домены, английский, образование, работодатели),
     * Этап 4: визуализации и сводка,
     * продуктовая часть (персоны),
     * итоговые выводы и чек‑лист.

2. **Парсинг (Этап 0):**

   * описать, как устроен парсер (что собирает, какие фильтры, ограничения);
   * показать пример сырого датасета (head, `.info()`, базовые counts);
   * связать с колонками финального датасета и словарём признаков.

3. **Предобработка и признаки (Этап 1–2):**

   * явно описать, какие функции из `cleaning.py` и `features.py` вызываются;
   * показать ключевые метрики до/после cleaning (дубликаты, пропуски, распределения зарплат);
   * перечислить важнейшие engineered features и объяснить, зачем они нужны.

4. **EDA (Этап 3) + корреляционный анализ:**

   * для каждого тематического блока (зарплаты, форматы, роли, навыки, домены, английский, образование, работодатели):

     * показать 1–2 таблицы и 1–2 графика,
     * написать 3–5 bullet‑выводов.
   * добавить отдельную секцию «Корреляционный анализ числовых признаков»:

     * использовать функцию(и) из `eda.py` для расчёта корреляций,
     * использовать функцию(и) из `viz.py` для heatmap,
     * дать интерпретацию (какие признаки сильнее всего связаны с зарплатой и т.д.).

5. **Персоны и продукт:**

   * использовать `personas.analyze_persona` для нескольких персоны;
   * для каждой:

     * показать `market_summary`,
     * таблицу skill‑gap,
     * список recommended_skills;
   * текстом описать, что это значит для человека и как Skillra может использовать эти данные.

6. **Финальные выводы и чек‑лист:**

   * итоги по рынку (5–7 пунктов);
   * итоги для продукта Skillra (3–5 пунктов);
   * чек‑лист соответствия ТЗ (с отсылками к секциям ноутбука).

**Название PR:** `step9_storyline_notebook_polish`.

---

### Step 10 — Чистый и непротиворечивый README

**Rазрешённые файлы:**

* `README.md`

**Цель:**

Сделать README кратким, непротиворечивым и согласованным с реальным состоянием проекта.

**Задачи:**

1. Переписать README так, чтобы он содержал:

   * краткое описание проекта (курс ВШЭ + продукт Skillra),
   * описание структуры репозитория (основные папки и их роли),
   * инструкции:

     * как запустить пайплайн (`python scripts/run_pipeline.py`),
     * как проверить проект (`python scripts/validate_pipeline.py`, `pytest`),
     * как открыть и использовать `notebooks/01_hse_project.ipynb`,
   * краткое описание:

     * `data/processed/market_view.parquet`,
     * personas‑API (`src/skillra_pda/personas.analyze_persona`).

2. Убрать:

   * дубли описаний одних и тех же действий,
   * любые ссылки на `notebooks/Group_project_draft.ipynb`,
   * устаревшие ссылки на файлы/модули.

3. Убедиться, что README:

   * не противоречит `CODEx_PLAN.md` и `AGENTS.md`,
   * отражает факт наличия `market.py` и `tests/`.

**Название PR:** `step10_readme_cleanup`.

---

## 7. Правила для Codex при выполнении шагов

1. Каждый Step N — отдельная задача и отдельный PR.
2. При выполнении Step N:

   * не изменяй файлы, не перечисленные в этом шаге;
   * не переписывай существующие модули целиком, если достаточно точечных правок;
   * сначала составь краткий план действий, затем вноси изменения.
3. Если код уже реализует то, что описано в шаге:

   * либо пропусти шаг,
   * либо сделай минимальные улучшения (docstring, выводы в ноуте).
4. После завершения всех шагов:

   * пайплайн (`run_pipeline.py`) должен работать,
   * тесты должны проходить,
   * ноутбук `01_hse_project.ipynb` — выполняться `Run All`,
   * README и docs — отражать актуальное состояние проекта.
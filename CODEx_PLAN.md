# CODEx_PLAN.md — план доведения `skillra_hse_pda` до целевого состояния (Data Quality → EDA → Personas → Notebook → HTML)

Версия: 2025-12-12

---

## 1) Что считаем “целевым состоянием”

Целевое состояние проекта — это не “много графиков”, а **честная и воспроизводимая аналитика**, пригодная для защиты/демо:

1) **Данные**:
   - raw не трогаем,
   - clean сохраняет истинную неполноту (NaN не “лечим медианой”),
   - features и market_view строятся воспроизводимо.

2) **Выводы**:
   - текст в ноутбуке не противоречит графикам,
   - в ключевых местах есть конкретные числа,
   - везде явно указаны `n` и доли `unknown/NaN` для важных признаков.

3) **Персоны**:
   - сегменты не “шумные” (есть min sample size),
   - skill-gap показывает релевантные hard skills (а не случайные флаги),
   - на графике видно market share и gap.

4) **Сортировки**:
   - грейды и английский отсортированы смыслово (низ→высокий),
   - форматы работы отсортированы смыслово.

5) **HTML‑отчёт**:
   - включает графики,
   - без кода,
   - с аккуратной типографикой и оглавлением.

---

## 2) Ключевые наблюдения по текущей базе (почему нужны правки)

### 2.1. “Идеальные данные” после clean

Нельзя делать EDA на датасете, где:
- числовые пропуски заполнены медианой “по умолчанию”,
- категориальные пропуски заполнены “unknown” во всех столбцах.

Это уничтожает “coverage” и маскирует качество данных.

### 2.2. “Цифры vs текст” и таксономия навыков

Если график строится только по `skill_*`, а Python хранится в `has_python`, то:
- график честно “не видит” Python,
- а markdown легко начинает противоречить графику.

Нужно: единый слой **hard skill taxonomy**.

### 2.3. Персоны шумят при малом n

Если персона фильтрует рынок до 5–15 вакансий, skill-gap становится случайным.
Нужно: min sample size + fallback‑логика ослабления фильтров.

### 2.4. Сортировки категорий

Грейды и английский должны иметь ordered порядок (низ→высокий),
иначе отчёт выглядит недостоверно.

---

## 3) Политика обработки пропусков и `unknown` (индустриальный стандарт для EDA)

### 3.1. Базовый принцип

- **Для EDA/отчёта не делаем “тихой” иммутации.**
- NaN остаются NaN, если нет явной бизнес‑семантики заполнения.

### 3.2. Разрешённая иммутация (только по явной политике)

Разрешены следующие правила:

1) **Булевы флаги** (role_*, skill_*, benefit_*, soft_*, domain_*, has_*):
   - если в данных встречается NA (редко), то для этих флагов корректно `fillna(False)`,
     потому что отсутствие сигнала = отсутствие признака.

2) **Счётчики** (например, количество отзывов):
   - NA можно заменить на 0, если это означает “0 записей”.

3) **Рейтинг работодателя**:
   - NA не заполняем медианой.
   - создаём флаг `employer_rating_known`.

4) **Зарплата**:
   - salary_from/salary_to не заполняем медианой.
   - salary_mid и salary_known считаются по прозрачным правилам.
   - валюты не конвертируем “по умолчанию”; non-RUB в отчёте помечаем отдельно.

5) **Категориальные признаки**:
   - NA не заполняем “unknown” глобально.
   - если в отчёте нужно показать долю “не указано”, это делается на уровне EDA/визуализации
     (например, отдельной строкой), либо в строго ограниченном списке колонок.

### 3.3. Дисклеймеры и coverage

Для каждого ключевого блока (salary, work_mode, grade, english, edu):
- показываем долю NaN/unknown,
- делаем текстовый дисклеймер при больших долях.

---

## 4) Визуальный стандарт (единый стиль)

- Заголовки/оси на русском.
- Размеры:
  - bar/box/line: один размер (например, 10×6),
  - heatmap: другой размер (например, 12×8).
- Функции графиков, используемые в ноутбуке, поддерживают `return_fig=True`
  и возвращают `(Figure, Path)`.

---

## 5) Workflow PR’ов

- Один Step = один PR.
- PR имена: как в шаге.
- В PR описании:
  - файлы,
  - что изменилось,
  - команды проверки.

---

## 6) Execution steps for Codex (актуальный sprint)

### Step 17 — Индустриальная политика пропусков и честный clean

**Goal:** перестать “лечить NaN медианой” и восстановить честное покрытие данных.

**Allowed files:**
- `src/skillra_pda/cleaning.py`
- `docs/02_feature_dictionary_hh.md` (аккуратные правки текста)

**What to do:**
1) В `cleaning.py` переработать `handle_missingness`:
   - убрать/ограничить глобальную иммутацию числовых колонок медианой;
   - сделать явный `NUMERIC_IMPUTE_RULES`:
     - счётчики → 0,
     - зарплатные поля → не заполнять,
     - рейтинг → не заполнять.
2) Аналогично по категориальным:
   - убрать/ограничить глобальное `fillna("unknown")` для всех строковых колонок;
   - разрешить “unknown” только там, где это осмысленно (например, grade/work_format, если нужно),
     либо оставить NaN и показывать “не указано” в EDA.
3) Улучшить `summarize_data_health`:
   - различать “реальные категории” и “маркеры пропуска”;
   - выводить долю NaN и долю маркеров пропуска по строковым колонкам;
   - для ключевых колонок добавить комментарий/семантику.
4) Обновить `docs/02_feature_dictionary_hh.md`:
   - зафиксировать новую политику (NaN не заполняем глобально),
   - объяснить как трактуем `unknown` и NaN в отчёте.

**Acceptance criteria:**
- После clean доля пропусков в `salary_from/salary_to` и `employer_rating` НЕ становится ≈0.
- Parquet сохраняется без ArrowInvalid.
- `python scripts/validate_pipeline.py` проходит.
- `pytest` проходит.

**Commands:**
- `python scripts/run_pipeline.py`
- `python scripts/validate_pipeline.py`
- `pytest`

**PR name:** `step17_clean_missingness_policy`

---

### Step 18 — Hard skill taxonomy: единый выбор навыков для EDA и графиков

**Goal:** устранить противоречия “на графике нет Python, а в тексте есть”.

**Allowed files:**
- `src/skillra_pda/eda.py`
- `src/skillra_pda/viz.py`
- `docs/02_feature_dictionary_hh.md` (минимально)

**What to do:**
1) В `eda.py` добавить helper:
   - `def hard_skill_columns(df) -> list[str]`
   - логика:
     - включить все `skill_*`,
     - включить релевантные `has_*` (языки/инструменты),
     - исключить нерелевантные `has_*` (например: `has_metro`, `has_test_task`, `has_mentoring`).
2) В `viz.py` обновить `top_skills_bar`:
   - `skill_cols: list[str] | None = None`
   - если `skill_cols is None`, использовать `eda.hard_skill_columns(df)`
   - отображать:
     - топ‑N навыков,
     - подписью долю (в % от вакансий сегмента), а не только counts.
3) Добавить mapping display‑имен:
   - `has_python` → “Python”
   - `skill_sql` → “SQL”
   - и т.д. (минимальный словарь для часто используемых)
4) Обновить текст в `docs/02_feature_dictionary_hh.md`:
   - что “hard skills” = `skill_* + selected has_*`.

**Acceptance criteria:**
- `viz.top_skills_bar(..., skill_cols=None)` в сегменте data показывает Python, если он есть в данных.
- Заголовки/оси на русском.
- Функция поддерживает `return_fig=True` и возвращает `(Figure, Path)`.

**Commands:**
- `pytest`

**PR name:** `step18_hard_skill_taxonomy`

---

### Step 19 — Персоны: min sample size + релевантный skill-gap + информативный график

**Goal:** убрать “случайные” навыки на графиках персон и сделать выводы осмысленными.

**Allowed files:**
- `src/skillra_pda/personas.py`
- `src/skillra_pda/viz.py` (если нужно для общих хелперов)
- `docs/02_feature_dictionary_hh.md` (минимально)

**What to do:**
1) В `personas.py` добавить min sample size:
   - параметр `min_market_n: int = 80` (или 100)
2) Реализовать fallback‑логику фильтрации:
   - стартуем со строгих фильтров (role/grade/work_mode/city_tier),
   - если `n < min_market_n`, ослабляем по одному в понятном порядке,
   - возвращаем в результате:
     - `vacancy_count`,
     - `applied_filters` (что реально применилось),
     - `warning` если `n` всё равно мало.
3) Для skill-gap использовать **hard skill taxonomy** (из Step 18) или локально такую же логику.
4) Улучшить `plot_persona_skill_gap`:
   - сортировать по gap (market_share – persona_has),
   - показывать проценты market share,
   - в заголовке: `n=...` и (если нужно) “filters relaxed”.
5) Пересмотреть дефолтные персоны:
   - убрать слишком жёсткие фильтры, которые дают `n < 20`,
   - оставить realistic настройки, чтобы графики были устойчивыми.

**Acceptance criteria:**
- Для ключевых персон сегмент не меньше `min_market_n` либо есть явный warning.
- На графике нет мусорных “навыков” вроде `has_metro`/`has_test_task`.
- В рекомендациях для data‑персоны появляются SQL/Python и т.п. (если есть в данных сегмента).
- `return_fig=True` возвращает `(fig, path)`.

**Commands:**
- `pytest`

**PR name:** `step19_personas_stable_skillgap`

---

### Step 20 — Ноутбук: цифры, честные дисклеймеры, отсутствие противоречий

**Goal:** сделать так, чтобы текст не мог противоречить графикам, потому что он порождается цифрами.

**Allowed files:**
- `notebooks/01_hse_project.ipynb`
- (опционально) `docs/02_feature_dictionary_hh.md` (минимально)

**What to do:**
1) В ноутбуке ввести практику:
   - после вычисления метрик выводить markdown через
     `from IPython.display import Markdown, display`
     и вставлять числа через f-string.
2) Для каждого большого блока EDA (зарплаты, формат работы, роли, навыки, домены, английский, образование, работодатели):
   - добавить 2–5 чисел в выводах (проценты/медианы/n),
   - если есть значимая доля unknown/NaN — дисклеймер с числом.
3) Убрать противоречия:
   - например, если график top skills строится без Python — либо исправить график (через Step 18), либо не упоминать Python.
   - предпочтение: исправить график и использовать hard skill taxonomy.
4) Добавить “честность данных”:
   - показывать missingness/coverage до/после clean и после features (таблицами).
5) Сортировки:
   - грейды и английский должны идти смыслово (низ→высокий) в таблицах и графиках.
6) Персоны:
   - текстовые выводы должны ссылаться на конкретные gap‑навыки, реально видимые на графике,
   - и учитывать `n` сегмента и warnings.

**Acceptance criteria:**
- В ключевых местах нет ручных “около 60%”, если это не вычислено.
- Нельзя найти явные противоречия “на графике X, в тексте Y”.
- Каждая картинка имеет immediately‑following markdown с числами и выводами.

**Commands:**
- `python scripts/validate_notebook.py` (желательно)
- либо “Run All” в ноутбуке

**PR name:** `step20_notebook_no_contradictions`

---

### Step 21 — HTML‑отчёт: типографика, оглавление, инвестор‑ready упаковка

**Goal:** HTML должен выглядеть как отчёт, а не как сырой экспорт.

**Allowed files:**
- `scripts/validate_notebook.py`
- `src/skillra_pda/config.py` (только пути к отчётам)
- `README.md` (раздел про HTML‑отчёт)
- опционально файлы в `reports/` (CSS/шаблон)

**What to do:**
1) Усилить CSS (без фанатизма):
   - читабельная ширина контента,
   - нормальные отступы,
   - аккуратные заголовки,
   - масштаб графиков,
   - кликабельное оглавление по разделам (Этап 0–4, EDA, Персоны, Выводы).
2) Убедиться, что экспорт включает outputs (графики) и скрывает input (код).
3) В конце `main()` печатать путь до HTML.
4) В `README.md` добавить секцию “HTML‑отчёт”:
   - команда,
   - путь сохранения,
   - назначение (демо/защита).

**Acceptance criteria:**
- `reports/notebooks/01_hse_project.html` содержит графики и выглядит аккуратно.
- Код скрыт.
- Есть оглавление.

**Commands:**
- `python scripts/validate_notebook.py`
- `pytest`

**PR name:** `step21_html_report_typography`

---

### Step 22 — (Опционально, но очень желательно) Parser: исправить источники `unknown` и ложные grade‑срабатывания

**Goal:** улучшить качество будущих сборов (чтобы через месяц не повторять те же проблемы).

**Allowed files:**
- `parser/hh_scraper.py`
- `parser/README.md`
- `docs/02_feature_dictionary_hh.md` (если нужно)

**What to do:**
1) Улучшить `GRADE_KEYWORDS` и `detect_grade`:
   - убрать слишком широкие триггеры (например, голое “lead” без контекста),
   - добавить контекстные паттерны (team lead, tech lead, тимлид, ведущий),
   - добавить защиту от “lead generation”.
2) В `parser/README.md` описать:
   - как тестировать парсер на малом лимите,
   - что grade/english/work_format — эвристики и имеют погрешность.
3) (Опционально) добавить минимальные unit‑проверки, если проект это допускает.

**Acceptance criteria:**
- `detect_grade("Lead Generation Specialist")` не возвращает `lead`.
- `detect_grade("Tech Lead Backend Engineer")` возвращает `lead`.

**PR name:** `step22_parser_grade_quality`

---

## 7) Финальный чек‑лист после всех merge

- `python scripts/run_pipeline.py` проходит
- `python scripts/validate_pipeline.py` проходит
- `python scripts/validate_notebook.py` генерирует HTML с графиками
- `pytest` проходит
- В ноутбуке нет очевидных противоречий “текст vs график”
- Во всех ключевых выводах есть числа и coverage‑дисклеймеры

---

# AGENTS.md — правила работы Codex в репозитории Skillra HSE PDA

Этот файл — “контракт” для Codex. Цель: довести репозиторий до целевого состояния без регрессий, без ломания пайплайна и без противоречий в аналитике.

---

## 0) Контекст и приоритеты

Проект: Career & Job Market Navigator (Skillra), учебный кейс HSE.

Приоритеты работ (в этом порядке):
1) **Данные и пайплайн обработки** (качество, прозрачность, воспроизводимость).
2) **Полировка и согласованность ноутбука** (графики + выводы без противоречий).
3) **Полировка HTML-отчёта** (графики внутри, эстетика, без кода).
4) **Полировка репозитория** (README/доки/структура).

---

## 1) Жёсткие запреты (важно)

1. **НЕ ТРОГАТЬ ПАРСЕР**: папка `parser/` и всё, что связано со сбором сырых данных — read-only.
2. **НЕ МЕНЯТЬ raw-датасет**: `data/raw/*.csv` — read-only.
3. Нельзя “чинить” проблему аналитики новой выгрузкой данных. Исправления делаем на стадиях cleaning/features/eda/viz/notebook.
4. Нельзя удалять функциональность или “упрощать” код, если это ломает существующие шаги пайплайна/ноутбука/скриптов.

---

## 2) Как Codex должен работать (обязательный протокол)

### 2.1 План → сразу код
Если включён режим планирования:
- Сначала дай короткий план (5–10 bullets).
- **СРАЗУ ПОСЛЕ ПЛАНА** приступай к правкам кода и созданию PR.
- Нельзя остановиться на “я предлагаю план”. Код и коммиты — обязательны.

### 2.2 Один шаг = один PR
- Каждый шаг из `CODEx_PLAN.md` выполняется отдельным PR.
- PR name и branch name должны соответствовать шагу.
- Никаких “смешанных” правок из разных шагов в одном PR.

### 2.3 Ограничение файлов
- В каждом шаге есть allowlist файлов. Менять можно **только** их.
- Если нужно больше файлов — остановись и попроси обновить allowlist (но по умолчанию старайся обойтись текущим списком).

---

## 3) Стандарты аналитики данных (то, что нельзя нарушать)

### 3.1 Политика пропусков и `unknown`
- `unknown` — это **служебная категория**, часто эквивалент пропусков.
- В любых “смысловых” долях (доли по грейдам, английскому, формату работы) должно быть:
  - либо явно указано “включая unknown”,
  - либо рассчитано “среди известных значений (exclude unknown)”.
- Нельзя молча смешивать `unknown` с настоящими категориями и делать вывод “рынок любит unknown”.

### 3.2 Никаких противоречий “текст ↔ график”
- Любое утверждение в выводах должно опираться на **конкретный вычисленный результат**:
  - топ навыков = из таблицы top skills,
  - доли = из рассчитанных долей,
  - медианы = из рассчитанных медиан.
- Если в тексте перечислены навыки, они должны присутствовать в соответствующем топе/графике (или должна быть явная оговорка “вне топ-N, но важен”).

### 3.3 Не делаем “тихую иммутацию”
- Если строится прокси-грейд / нормализация английского / каппинг зарплат — это должно быть:
  - названо отдельной колонкой (например, `grade_final`),
  - описано в ноутбуке как преобразование,
  - измерено “сколько строк затронуто”.

---

## 4) Стандарты визуализации

1) Все графики:
- имеют русскоязычный заголовок,
- имеют понятные подписи осей,
- имеют стабильный размер (или единый display-width в ноутбуке),
- имеют смысловую сортировку категорий:
  - grade: intern → junior → middle → senior → lead → unknown,
  - english: no_english/none → A1 → A2 → B1 → B2 → C1+ → unknown,
  - work_mode: office → hybrid → remote → field → unknown.

2) В ноутбуке:
- график должен отображаться **ровно один раз** (без дублей),
- предпочтительный паттерн: `path = viz.fn(...); display(Image(path))`.

3) Персоны:
- графики должны содержать N рынка и применённые фильтры (хотя бы в подписи/подзаголовке),
- названия навыков должны быть human-readable (не `skill_xxx`, а “XXX”).

---

## 5) Проверки перед завершением шага (Definition of Done на шаг)

Минимальный набор команд:
- `python scripts/validate_pipeline.py`
- `pytest -q`
- `python scripts/validate_notebook.py` (должен сгенерировать HTML с графиками)

Если команда падает:
- исправь причину или явно опиши проблему и предложи минимальный фикс в рамках шага.

---

## 6) Стиль кода и сопровождение

- Сохраняй существующую архитектуру `src/skillra_pda`.
- Добавляй небольшие чистые функции вместо копипасты.
- Типы и docstring — по необходимости, но критичные места должны быть понятны.
- Логика сортировок/маппингов должна жить централизованно (константы/хелперы), а не разъезжаться по ноутбуку.

---

## 7) Что считается успехом

Успех — это когда:
- пайплайн воспроизводим,
- ноутбук самодостаточен, графики видны, выводы непротиворечивы,
- HTML отчёт красивый и с графиками,
- репо выглядит как аккуратный data-product прототип.
